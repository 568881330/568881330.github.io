<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è½¨è¿¹(ç™¾åº¦)</title>
    <style>
        html, body, #container {
            margin: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        #shijian {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 200;
            padding: 12px 0;
            background: rgba(255,255,255,0.9);
            border: none;
            border-top: 1px solid #ddd;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        #shijian:hover {
            background: rgba(245,245,245,0.9);
        }
        #timeInfo {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 200;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.5;
        }
        #pointCount {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 200;
            font-size: 13px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .aa {
            box-shadow: 0 0 3px 2px #A020F0;
            width: 20px;
            height: 20px;
            transform: rotate(45deg);
        }
        .qq {
            position: absolute;
            border-radius: 20px;
            transform: rotate(-45deg);
            top: -20px;
            left: -20px;
        }
        .car-icon {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div id='container'>åŠ è½½ä¸­...</div>
    <div id="timeInfo"></div>
    <div id="pointCount"></div>
    <input type="button" value="åŠ è½½è½¨è¿¹æ•°æ®..." id="shijian" onclick="Play()">
    <script src='https://webapi.amap.com/maps?v=2.0&key=47d57deacf67daf4fe68b31c3dcdc253'></script>
    <script>
        // ç”Ÿæˆéšæœºå‚æ•°é˜²æ­¢ç¼“å­˜
        const randomParam = Date.now();
        let key = JSON.parse('{"' + decodeURIComponent(location.search.substr(1)).replace(/\=/g, '":"').replace(/&/g, '","') + '"}');
        let pi = 1;
        let guiji = [];
        let loctime = [];
        let speed = [];
        let endtime;
        let dj = 1;
        let map, marker, at;

        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.getFullYear() + '-' + 
                   (date.getMonth()+1).toString().padStart(2, '0') + '-' + 
                   date.getDate().toString().padStart(2, '0') + ' ' + 
                   date.getHours().toString().padStart(2, '0') + ':' + 
                   date.getMinutes().toString().padStart(2, '0') + ':' + 
                   date.getSeconds().toString().padStart(2, '0');
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return (h > 0 ? h + 'å°æ—¶' : '') + 
                   (m > 0 ? m + 'åˆ†' : '') + 
                   (s > 0 ? s + 'ç§’' : '');
        }

        function BaiDu(j) {
            try {
                if (!j.points || j.points.length === 0) {
                    container.innerHTML = 'æ²¡æœ‰è·å–åˆ°è½¨è¿¹æ•°æ®';
                    shijian.value = 'æ²¡æœ‰è½¨è¿¹æ•°æ®';
                    return;
                }

                const t = JSON.stringify(j.points).match(/(?<=de":)\d+\.\d{1,6}/g);
                let n;
                
                for (let i = 0; i < j.points.length; i++) {
                    guiji.push([parseFloat(t[2 * i + 1]), parseFloat(t[2 * i])]);
                    loctime.push(j.points[i].loc_time);
                    speed.push(j.points[i].speed || 0);
                    
                    if (j.points[i + 1]) {
                        n = j.points[i + 1].loc_time - j.points[i].loc_time;
                        if (n > key.duan) {
                            endtime = j.points[i].loc_time;
                            break;
                        }
                    }
                }

                n = n || key.duan + 1;
                
                if (n > key.duan || j.end_point.loc_time === j.points[j.points.length - 1].loc_time) {
                    endtime = endtime || j.end_point.loc_time;
                    Getlicheng();
                    GaoDe();
                } else {
                    GetData(pi++);
                }
            } catch (e) {
                console.error('æ•°æ®å¤„ç†é”™è¯¯:', e);
                container.innerHTML = 'æ•°æ®å¤„ç†å‡ºé”™: ' + e.message;
            }
        }

        function GaoDe() {
            try {
                container.innerHTML = '';
                document.getElementById('pointCount').textContent = 'è½¨è¿¹ç‚¹æ•°: ' + guiji.length;
                
                map = new AMap.Map("container", {
                    zoom: 17,
                    center: guiji[0],
                    viewMode: '3D'
                });

                // æ˜¾ç¤ºå¼€å§‹å’Œç»“æŸæ—¶é—´
                const startTime = formatTime(loctime[0]);
                const finishTime = formatTime(loctime[loctime.length-1]);
                document.getElementById('timeInfo').innerHTML = 
                    `<strong>è½¨è¿¹æ—¶é—´</strong><br>
                     å¼€å§‹: ${startTime}<br>
                     ç»“æŸ: ${finishTime}`;

                if (key.qq) {
                    // ä½¿ç”¨QQå¤´åƒ
                    at = false;
                    AMap.plugin('AMap.MoveAnimation', function() {
                        marker = new AMap.Marker({
                            map: map,
                            position: guiji[0],
                            content: `<div class="aa">< img class="qq" src="https://q.qlogo.cn/g?b=qq&nk=${key.qq}&s=100" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAyNCAyNCcgZmlsbD0nIzAwMDAwMCc+PHBhdGggZD0iTTggMTJhMSAxIDAgMCAxIDEtMWg2YTEgMSAwIDAgMSAxIDF2M2ExIDEgMCAwIDEtMSAxaC0yYTEgMSAwIDAgMC0xIDF2MmExIDEgMCAwIDEtMSAxaC0yYTEgMSAwIDAgMS0xLTF2LTZhMSAxIDAgMCAxIDEtMXptOS03YTEgMSAwIDAgMSAxLTFoMmExIDEgMCAwIDEgMSAxdjJhMSAxIDAgMCAxLTEgMWgtMmExIDEgMCAwIDEtMS0xVjV6TTQgNWEyIDIgMCAwIDEgMi0yaDJhMiAyIDAgMCAxIDIgMnYyYTIgMiAwIDAgMS0yIDJINmEyIDIgMCAwIDEtMi0yVjV6Ii8+PC9zdmc+'"></div>`,
                            offset: [-10, -24]
                        });
                    });
                } else {
                    // ä½¿ç”¨å°è½¦å›¾æ ‡
                    at = true;
                    AMap.plugin('AMap.MoveAnimation', function() {
                        marker = new AMap.Marker({
                            map: map,
                            position: guiji[0],
                            content: `<div class="car-icon">ğŸš—</div>`,
                            offset: [-12, -24]
                        });
                    });
                }

                // ç»˜åˆ¶å®Œæ•´è½¨è¿¹çº¿
                const polyline = new AMap.Polyline({
                    map: map,
                    path: guiji,
                    showDir: true,
                    strokeColor: "#28a745",
                    strokeWeight: 6,
                    strokeOpacity: 0.7
                });

                // ç»˜åˆ¶å·²èµ°è¿‡è½¨è¿¹çº¿
                const passedPolyline = new AMap.Polyline({
                    map: map,
                    strokeColor: "#dc3545",
                    strokeWeight: 4,
                    strokeOpacity: 0.9
                });

                marker.on('moving', function(e) {
                    passedPolyline.setPath(e.passedPath);
                    map.setCenter(e.passedPos);
                    if (!at && e.progress === 1) {
                        marker.setLabel({
                            content: formatTime(loctime[e.index]) + " " + speed[e.index].toFixed(0) + "km/h",
                            offset: [20, -50]
                        });
                    }
                });

                marker.on('movealong', function() {
                    dj = 2;
                    shijian.value = 'æ’­æ”¾å®Œæˆï¼Œç‚¹å‡»é‡æ–°æ’­æ”¾';
                });

                map.setFitView();
                
                if (guiji.length > 1) {
                    shijian.value = 'ç‚¹å‡»å¼€å§‹æ’­æ”¾è½¨è¿¹';
                    setTimeout(() => {
                        map.setFitView(null, false, [50, 50, 50, 100]);
                    }, 500);
                } else {
                    shijian.value = 'åªæœ‰ä¸€ä¸ªåæ ‡ç‚¹ï¼Œæ— æ³•æ’­æ”¾';
                }
            } catch (e) {
                console.error('åœ°å›¾åˆå§‹åŒ–é”™è¯¯:', e);
                container.innerHTML = 'åœ°å›¾åˆå§‹åŒ–å‡ºé”™: ' + e.message;
            }
        }

        function Go() {
            if (guiji.length > 1) {
                marker.moveAlong(guiji, {
                    duration: 50,
                    autoRotation: at
                });
            }
        }

        function GetData() {
            console.log('è·å–äº‘ç«¯æ•°æ®ç¬¬' + pi + 'é¡µ');
            const script = document.createElement('script');
            script.src = `https://yingyan.baidu.com/api/v3/track/gettrack?callback=BaiDu&coord_type_output=gcj02&page_size=600&page_index=${pi}&${location.search.substr(1)}&nocache=${randomParam}`;
            script.onerror = function() {
                container.innerHTML = 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å‚æ•°';
                shijian.value = 'æ•°æ®åŠ è½½å¤±è´¥';
            };
            document.body.appendChild(script);
            setTimeout(() => document.body.removeChild(script), 100);
        }

        function Getlicheng() {
            console.log('è·å–é‡Œç¨‹æ•°æ®');
            const script = document.createElement('script');
            script.src = `https://yingyan.baidu.com/api/v3/track/getdistance?callback=BaiDulicheng&ak=${key.ak}&service_id=${key.service_id}&entity_name=${key.entity_name}&start_time=${key.start_time}&end_time=${endtime}&nocache=${randomParam}`;
            script.onerror = function() {
                shijian.value = 'é‡Œç¨‹è®¡ç®—å¤±è´¥';
            };
            document.body.appendChild(script);
            setTimeout(() => document.body.removeChild(script), 100);
        }

        function BaiDulicheng(j) {
            try {
                if (j.distance === undefined) {
                    shijian.value = 'æ— æ³•è®¡ç®—é‡Œç¨‹';
                    return;
                }
                
                const distance = (j.distance / 1000).toFixed(1);
                const duration = endtime - loctime[0];
                const durationStr = formatDuration(duration);
                
                shijian.value = `æ€»é‡Œç¨‹: ${distance}å…¬é‡Œ | æ€»æ—¶é—´: ${durationStr} | ç‚¹å‡»æ’­æ”¾è½¨è¿¹`;
            } catch (e) {
                console.error('é‡Œç¨‹è®¡ç®—é”™è¯¯:', e);
                shijian.value = 'é‡Œç¨‹è®¡ç®—å‡ºé”™';
            }
        }

        function Play() {
            if (!marker) return;
            
            if (dj === 1) {
                // æš‚åœ
                dj = 0;
                marker.pauseMove();
                shijian.value = 'å·²æš‚åœï¼Œç‚¹å‡»ç»§ç»­æ’­æ”¾';
            } else if (dj === 2) {
                // é‡æ–°æ’­æ”¾
                marker.moveTo(guiji[0]);
                setTimeout(Go, 300);
                dj = 1;
                shijian.value = 'æ­£åœ¨æ’­æ”¾ï¼Œç‚¹å‡»æš‚åœ';
            } else {
                // ç»§ç»­æ’­æ”¾
                marker.resumeMove();
                dj = 1;
                shijian.value = 'æ­£åœ¨æ’­æ”¾ï¼Œç‚¹å‡»æš‚åœ';
            }
        }

        // åˆå§‹åŠ è½½æ•°æ®
        GetData();
    </script>
</body>
</html>
